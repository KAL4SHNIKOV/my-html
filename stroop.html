<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stroop Task</title>
  <style>
    :root {
      --bg: #ffffff;
      --text: #1e293b;
      --border: #e2e8f0;
    }
    body { margin: 0; font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

    /* Header & Settings */
    header { padding: 16px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #f8fafc; }
    h1 { margin: 0; font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
    
    .settings-bar { display: flex; gap: 16px; align-items: center; }
    .setting-item { display: flex; flex-direction: column; }
    .setting-item label { font-size: 0.7rem; color: #64748b; font-weight: 600; text-transform: uppercase; }
    .setting-item input { border: 1px solid #cbd5e1; border-radius: 4px; padding: 4px 8px; font-size: 0.9rem; width: 80px; }
    
    .btn { padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; border: none; font-size: 0.9rem; }
    .btn-primary { background: #0f172a; color: white; }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-outline { border: 1px solid #cbd5e1; background: white; color: #0f172a; }

    /* Stage */
    .stage { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
    
    .fixation { font-size: 4rem; color: #cbd5e1; font-weight: 300; }
    .stimulus { font-size: 6rem; font-weight: 900; letter-spacing: 2px; transition: transform 0.1s; }
    
    .feedback-msg { position: absolute; top: 20%; font-size: 1.5rem; font-weight: bold; opacity: 0; transition: opacity 0.2s; }
    .feedback-msg.show { opacity: 1; }

    /* Key Mapping Bar */
    .key-bar { 
      padding: 40px; border-top: 1px solid var(--border); 
      display: flex; justify-content: center; gap: 20px; background: #f8fafc; 
    }
    
    .color-key {
      position: relative;
      width: 100px; height: 100px;
      border-radius: 12px;
      border: 4px solid transparent;
      background: white;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: transform 0.1s, box-shadow 0.1s;
    }
    
    .color-key::before {
      content: ''; display: block; width: 40px; height: 40px; border-radius: 50%; margin-bottom: 8px;
    }
    
    .color-key[data-color="red"]::before { background: #ef4444; }
    .color-key[data-color="green"]::before { background: #22c55e; }
    .color-key[data-color="blue"]::before { background: #3b82f6; }
    .color-key[data-color="yellow"]::before { background: #eab308; }

    .color-key .key-label { font-size: 1.2rem; font-weight: 700; color: #94a3b8; font-family: monospace; }
    
    /* Active States */
    .color-key.active { transform: translateY(4px); box-shadow: none; background: #e2e8f0; }
    .color-key[data-color="red"].active { border-color: #ef4444; }
    .color-key[data-color="green"].active { border-color: #22c55e; }
    .color-key[data-color="blue"].active { border-color: #3b82f6; }
    .color-key[data-color="yellow"].active { border-color: #eab308; }

    /* Results Modal (Simple Overlay) */
    .stats-overlay {
      position: absolute; top: 20px; right: 20px;
      background: rgba(255,255,255,0.9);
      padding: 15px; border: 1px solid #e2e8f0; border-radius: 8px;
      font-size: 0.85rem; pointer-events: none;
    }
  </style>
</head>
<body>

<header>
  <h1>
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M12 8v8"></path><path d="M8 12h8"></path></svg>
    Stroop Task
  </h1>
  <div class="settings-bar">
    <div class="setting-item">
      <label>Trials</label>
      <input type="number" id="nTrials" value="40">
    </div>
    <div class="setting-item">
      <label>Incongruent %</label>
      <input type="number" id="ratio" value="50">
    </div>
    <div class="setting-item">
      <label>Duration (ms)</label>
      <input type="number" id="dur" value="1500">
    </div>
    <button class="btn btn-primary" id="startBtn">Start Task</button>
    <button class="btn btn-outline" id="dlBtn" disabled>CSV</button>
  </div>
</header>

<main class="stage">
  <div class="stats-overlay" id="statsBox">Ready</div>
  <div class="feedback-msg" id="feedback"></div>
  <div class="fixation" id="fix">+</div>
  <div class="stimulus" id="stim" style="display:none;">RED</div>
</main>

<div class="key-bar">
  <div class="color-key" data-color="red" id="keyRed"><span class="key-label">D</span></div>
  <div class="color-key" data-color="green" id="keyGreen"><span class="key-label">F</span></div>
  <div class="color-key" data-color="blue" id="keyBlue"><span class="key-label">J</span></div>
  <div class="color-key" data-color="yellow" id="keyYellow"><span class="key-label">K</span></div>
</div>

<script>
  // Config
  const KEY_MAP = {
    'd': 'red', 'D': 'red',
    'f': 'green', 'F': 'green',
    'j': 'blue', 'J': 'blue',
    'k': 'yellow', 'K': 'yellow'
  };
  
  const COLORS = [
    { name: 'Red', hex: '#ef4444', id: 'red' },
    { name: 'Green', hex: '#22c55e', id: 'green' },
    { name: 'Blue', hex: '#3b82f6', id: 'blue' },
    { name: 'Yellow', hex: '#eab308', id: 'yellow' }
  ];

  const el = id => document.getElementById(id);
  const sleep = ms => new Promise(r => setTimeout(r, ms));

  let running = false;
  let results = [];
  let abortController = null;

  async function runBlock() {
    if(running) return;
    running = true;
    results = [];
    abortController = new AbortController();
    
    // UI Setup
    el('startBtn').disabled = true;
    el('dlBtn').disabled = true;
    document.querySelectorAll('.setting-item input').forEach(i => i.disabled = true);
    
    const n = Number(el('nTrials').value);
    const ratio = Number(el('ratio').value) / 100;
    const dur = Number(el('dur').value);

    // Generate Trials
    const trials = [];
    for(let i=0; i<n; i++) {
        const isIncong = Math.random() < ratio;
        const ink = COLORS[Math.floor(Math.random() * COLORS.length)];
        let word = ink;
        
        if(isIncong) {
            // Pick a different word
            const others = COLORS.filter(c => c.id !== ink.id);
            word = others[Math.floor(Math.random() * others.length)];
        }
        trials.push({ id: i+1, type: isIncong ? 'Incong' : 'Cong', ink, word });
    }

    try {
        for(const t of trials) {
            if(abortController.signal.aborted) break;

            // 1. Fixation
            el('stim').style.display = 'none';
            el('fix').style.display = 'block';
            el('feedback').classList.remove('show');
            
            await sleep(500); // ITI
            
            // 2. Stimulus
            el('fix').style.display = 'none';
            const stim = el('stim');
            stim.textContent = t.word.name; // The Text
            stim.style.color = t.ink.hex;   // The Color
            stim.style.display = 'block';

            const t0 = performance.now();
            const respColor = await waitForResponse(dur, abortController.signal);
            const rt = respColor ? Math.round(performance.now() - t0) : 0;
            
            // 3. Evaluate
            const acc = respColor === t.ink.id ? 1 : 0;
            results.push({ ...t, resp: respColor || 'timeout', acc, rt });
            
            // 4. Feedback
            updateStats();
            if(!respColor) showFeedback("Timeout", "#64748b");
            else if(!acc) showFeedback("X", "#ef4444");
        }
    } catch(e) { console.log('Stopped'); }
    
    finish();
  }

  function finish() {
    running = false;
    el('startBtn').disabled = false;
    el('dlBtn').disabled = false;
    document.querySelectorAll('.setting-item input').forEach(i => i.disabled = false);
    el('stim').style.display = 'none';
    el('fix').style.display = 'block';
    el('fix').textContent = "Done";
  }

  function showFeedback(text, color) {
    const fb = el('feedback');
    fb.textContent = text;
    fb.style.color = color;
    fb.classList.add('show');
  }

  function updateStats() {
    const acc = Math.round((results.filter(r => r.acc).length / results.length) * 100);
    const valid = results.filter(r => r.acc);
    const meanRt = valid.length ? Math.round(valid.reduce((a,b)=>a+b.rt,0)/valid.length) : 0;
    
    // Stroop Effect
    const congRt = valid.filter(r=>r.type==='Cong').reduce((a,b)=>a+b.rt,0) / valid.filter(r=>r.type==='Cong').length || 0;
    const incongRt = valid.filter(r=>r.type==='Incong').reduce((a,b)=>a+b.rt,0) / valid.filter(r=>r.type==='Incong').length || 0;
    const effect = Math.round(incongRt - congRt);

    el('statsBox').innerHTML = `
      <strong>Stats</strong><br>
      Acc: ${acc}%<br>
      RT: ${meanRt}ms<br>
      Effect: ${effect > 0 ? '+' : ''}${effect}ms
    `;
  }

  function waitForResponse(ms, signal) {
    return new Promise(resolve => {
        let timer;
        const handler = (e) => {
            const color = KEY_MAP[e.key];
            if(color) {
                highlightKey(color);
                cleanup();
                resolve(color);
            }
        };
        const cleanup = () => {
            clearTimeout(timer);
            window.removeEventListener('keydown', handler);
        };
        window.addEventListener('keydown', handler);
        timer = setTimeout(() => { cleanup(); resolve(null); }, ms);
        signal.addEventListener('abort', () => { cleanup(); resolve(null); });
    });
  }

  function highlightKey(colorId) {
    const k = document.querySelector(`.color-key[data-color="${colorId}"]`);
    if(k) {
        k.classList.add('active');
        setTimeout(() => k.classList.remove('active'), 150);
    }
  }

  el('startBtn').onclick = runBlock;
  el('dlBtn').onclick = () => {
      const csv = "Trial,Condition,Word,Ink,Resp,Acc,RT\n" + 
        results.map(r => `${r.id},${r.type},${r.word.name},${r.ink.name},${r.resp},${r.acc},${r.rt}`).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'stroop_data.csv'; a.click();
  };

</script>
</body>
</html>
