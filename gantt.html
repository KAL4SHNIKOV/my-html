<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gantt Pro - æ—¥é—´æŠ¥å‘Šç‰ˆ</title>
  <style>
    :root {
      /* --- æ—¥é—´æ¨¡å¼ (Light Mode) å•†åŠ¡é…è‰² --- */
      --bg-body: #f1f5f9;      /* æµ…ç°èƒŒæ™¯ */
      --bg-panel: #ffffff;     /* çº¯ç™½é¢æ¿ */
      --bg-input: #f8fafc;     /* è¾“å…¥æ¡†ææµ…ç° */
      --border: #e2e8f0;       /* è¾¹æ¡†æ·¡ç° */
      
      --primary: #3b82f6;      /* å•†åŠ¡è“ */
      --primary-hover: #2563eb;
      
      --text-main: #1e293b;    /* æ·±è‰²æ­£æ–‡ */
      --text-muted: #64748b;   /* è¾…åŠ©æ–‡å­— */
      
      --danger: #ef4444;
      --success: #10b981;
      
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --radius: 6px;
      
      --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "PingFang SC", "Microsoft YaHei", sans-serif;
      --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    }

    * { box-sizing: border-box; outline: none; }
    
    body {
      margin: 0;
      font-family: var(--font-sans);
      background-color: var(--bg-body);
      color: var(--text-main);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* --- Header --- */
    header {
      height: 56px;
      background-color: var(--bg-panel);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      flex-shrink: 0;
      z-index: 10;
      box-shadow: var(--shadow-sm);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
      font-size: 18px;
      color: var(--primary);
    }
    .brand input {
      background: transparent;
      border: 1px solid transparent;
      color: var(--text-main);
      font-size: 16px;
      font-weight: 600;
      width: 280px;
      padding: 4px 8px;
      border-radius: var(--radius);
      transition: all 0.2s;
    }
    .brand input:hover, .brand input:focus {
      background: var(--bg-input);
      border-color: var(--border);
    }

    .actions { display: flex; gap: 8px; }

    button {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      color: var(--text-main);
      padding: 6px 12px;
      border-radius: var(--radius);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex; align-items: center; gap: 6px;
    }
    button:hover { background-color: #f8fafc; border-color: #cbd5e1; }
    button:active { transform: translateY(1px); }
    
    button.primary { background-color: var(--primary); border-color: var(--primary); color: white; }
    button.primary:hover { background-color: var(--primary-hover); }
    
    button.danger { color: #dc2626; border-color: #fecaca; background: #fef2f2; }
    button.danger:hover { background: #fee2e2; }

    /* --- Toolbar --- */
    .toolbar {
      height: 52px;
      background-color: var(--bg-panel);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 20px;
      gap: 20px;
      flex-shrink: 0;
      overflow-x: auto;
    }
    
    .tool-group {
      display: flex; align-items: center; gap: 12px;
      font-size: 12px; color: var(--text-muted);
      border-right: 1px solid var(--border);
      padding-right: 20px;
    }
    .tool-group:last-child { border-right: none; }
    .tool-title { font-weight: 600; margin-right: 4px; color: var(--text-main); }

    .tool-item { display: flex; align-items: center; gap: 6px; }
    .tool-item label { cursor: pointer; user-select: none; }
    
    input[type="range"] { width: 80px; accent-color: var(--primary); }
    input[type="checkbox"] { accent-color: var(--primary); width: 14px; height: 14px; }
    
    input[type="number"], input[type="date"] {
      background: var(--bg-input);
      border: 1px solid var(--border);
      color: var(--text-main);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-family: var(--font-mono);
    }
    input[type="number"]:focus, input[type="date"]:focus { border-color: var(--primary); background: #fff; }

    /* --- Workspace --- */
    .workspace { display: flex; flex: 1; overflow: hidden; }

    /* Left Panel */
    .panel-left {
      width: 440px;
      background-color: #ffffff;
      border-right: 1px solid var(--border);
      display: flex; flex-direction: column;
      flex-shrink: 0;
      z-index: 5;
    }
    
    .panel-header {
      padding: 10px 16px;
      font-size: 12px; font-weight: 600; color: var(--text-muted);
      background: #f8fafc;
      border-bottom: 1px solid var(--border);
      display: flex; justify-content: space-between;
    }

    .task-list { flex: 1; overflow-y: auto; padding: 12px; background: #fff; }
    
    .task-row {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 6px;
      margin-bottom: 8px;
      padding: 10px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.02);
      transition: all 0.2s;
    }
    .task-row:hover { border-color: #cbd5e1; box-shadow: 0 2px 4px rgba(0,0,0,0.04); }
    .task-row:focus-within { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }
    
    .row-top { grid-column: 1 / -1; display: flex; gap: 8px; align-items: center; }
    .row-top input.name {
      width: 100%; border: none; background: transparent;
      color: var(--text-main); font-weight: 600; font-size: 14px; padding: 2px 0;
    }
    .row-top .row-idx {
      font-size: 11px; font-family: var(--font-mono); color: var(--text-muted);
      background: #f1f5f9; padding: 1px 5px; border-radius: 4px;
    }

    .row-detail {
      display: grid; grid-template-columns: 1fr 1fr 0.7fr 0.7fr auto; gap: 8px; align-items: center;
    }
    .field-group { display: flex; flex-direction: column; gap: 2px; }
    .field-group label { font-size: 10px; color: var(--text-muted); }
    .field-group input { width: 100%; }
    
    .btn-del-row {
      background: transparent; border: none; color: #cbd5e1;
      padding: 4px; cursor: pointer; margin-top: 14px;
    }
    .btn-del-row:hover { color: var(--danger); }

    /* TSV Area */
    .tsv-area {
      height: 140px; border-top: 1px solid var(--border); background: #f8fafc;
      display: flex; flex-direction: column;
    }
    .tsv-header { padding: 6px 12px; font-size: 11px; color: var(--text-muted); display: flex; justify-content: space-between; align-items: center; }
    .tsv-area textarea {
      flex: 1; border: none; background: transparent; padding: 10px;
      color: var(--text-main); font-family: var(--font-mono); font-size: 11px; resize: none;
    }

    /* Right Panel (Chart) */
    .panel-right {
      flex: 1; display: flex; flex-direction: column;
      position: relative; background: #ffffff; overflow: hidden;
    }
    
    .chart-status {
      position: absolute; bottom: 16px; right: 20px;
      background: rgba(255,255,255,0.9);
      border: 1px solid var(--border);
      padding: 6px 12px; border-radius: 20px;
      font-size: 11px; color: var(--text-muted);
      pointer-events: none;
      box-shadow: var(--shadow-sm);
    }

    .scroller {
      flex: 1; overflow: auto; cursor: grab; position: relative;
      background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
      background-size: 20px 20px;
    }
    .scroller:active { cursor: grabbing; }

    /* Export Frame */
    .export-container { display: inline-block; padding: 20px; background: white; }

    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 5px; border: 2px solid #f1f5f9; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
  </style>
</head>
<body>

  <header>
    <div class="brand">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/></svg>
      <input id="docTitle" value="é¡¹ç›®è¿›åº¦è®¡åˆ’è¡¨" />
    </div>
    <div class="actions">
      <button class="primary" id="btnAdd">ï¼‹ æ–°å¢</button>
      <button id="btnSave">ä¿å­˜</button>
      <button id="btnLoad">è¯»å–</button>
      <div style="width:1px;height:20px;background:var(--border);margin:0 4px;"></div>
      <button id="btnPNG" title="æ¨èWordä½¿ç”¨">ğŸ“· å¯¼å‡ºPNG</button>
      <button class="danger" id="btnReset" title="é‡ç½®">â†º</button>
    </div>
  </header>

  <div class="toolbar">
    <div class="tool-group">
      <span class="tool-title">è§†å›¾ç¼©æ”¾</span>
      <div class="tool-item">
        <label>åˆ—å®½</label>
        <input id="zoom" type="range" min="15" max="80" value="34" title="è°ƒæ•´æ¯å¤©çš„å®½åº¦" />
      </div>
      <div class="tool-item">
        <label>è¡Œé«˜</label>
        <input id="rowH" type="range" min="28" max="60" value="38" />
      </div>
    </div>
    
    <div class="tool-group">
      <span class="tool-title">ç©ºé—´å‹ç¼©</span>
      <div class="tool-item" title="å‹¾é€‰åä¸æ˜¾ç¤ºå‘¨å…­æ—¥ï¼Œæ˜¾è‘—ç¼©çŸ­å›¾è¡¨é•¿åº¦">
        <input id="hideWeekends" type="checkbox" />
        <label for="hideWeekends">éšè—å‘¨æœ«</label>
      </div>
       <div class="tool-item" title="æ˜¾ç¤ºå‘¨åºå·">
        <input id="showWeeks" type="checkbox" checked />
        <label for="showWeeks">æ˜¾ç¤ºå‘¨åˆ—</label>
      </div>
    </div>

    <div class="tool-group">
      <span class="tool-title">æ˜¾ç¤ºèŒƒå›´ (è£å‰ª)</span>
      <div class="tool-item">
        <label>å¼€å§‹</label>
        <input id="viewStart" type="date" title="ç•™ç©ºåˆ™è‡ªåŠ¨è®¡ç®—" />
      </div>
      <div class="tool-item">
        <label>ç»“æŸ</label>
        <input id="viewEnd" type="date" title="ç•™ç©ºåˆ™è‡ªåŠ¨è®¡ç®—" />
      </div>
    </div>
  </div>

  <div class="workspace">
    <aside class="panel-left">
      <div class="panel-header">
        <span>ä»»åŠ¡æ¸…å•</span>
        <div style="display:flex;align-items:center;gap:10px;">
          <button class="danger" id="btnClearTasks" style="padding:2px 8px;font-size:11px;background:#fff">æ¸…ç©º</button>
          <span style="font-size:11px;color:var(--text-muted);font-weight:500;">æ€»å·¥æœŸï¼š<span id="totalDuration">â€”</span><span id="totalRange" style="margin-left:6px;"></span></span>
          <span style="font-weight:400;opacity:0.8">å¯ç›´æ¥æ‹–æ‹½å³ä¾§å›¾è¡¨</span>
        </div>
      </div>
<div class="task-list" id="rows"></div>
      <div class="tsv-area">
        <div class="tsv-header">
          <span>Excel/TSV å¯¼å…¥ (é¡¹ç›® | å¼€å§‹æ—¥æœŸ | å·¥æœŸ)</span>
          <button id="btnImport" style="padding:2px 8px;font-size:11px;background:#fff">å¯¼å…¥</button>
        </div>
        <textarea id="tsvIn" placeholder="æŒ‰ TSV ç²˜è´´ï¼šé¡¹ç›®\tå¼€å§‹æ—¥æœŸ\tå·¥æœŸï¼ˆå¤©ï¼‰..."></textarea>
      </div>
    </aside>

    <main class="panel-right">
      <div class="scroller" id="scroller">
        <div class="export-container" id="exportFrame">
          <svg id="svg" xmlns="http://www.w3.org/2000/svg"></svg>
        </div>
      </div>
      <div class="chart-status" id="statusPill">å°±ç»ª</div>
    </main>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const MS = 24*60*60*1000;
  
  // --- æ ·å¼é…ç½®ï¼ˆæ—¥é—´æ¨¡å¼ï¼‰ ---
  const config = {
    colors: {
      grid: "#f1f5f9",         // ææ·¡çš„ç½‘æ ¼çº¿
      gridWeek: "#e2e8f0",     // å‘¨åˆ†éš”çº¿
      gridWeekend: "#f8fafc",  // å‘¨æœ«èƒŒæ™¯è‰²
      text: "#64748b",         // è½´æ–‡å­—
      textMain: "#0f172a",     // æ ‡é¢˜æ–‡å­—
      barStart: "#3b82f6",     // è“è‰²æ¸å˜èµ·
      barEnd: "#60a5fa",       // è“è‰²æ¸å˜æ­¢
      barBorder: "#2563eb",    // è¾¹æ¡†è‰²
      headerBg: "#ffffff",     // å¤´éƒ¨èƒŒæ™¯
      headerLine: "#cbd5e1",   // å¤´éƒ¨ä¸‹åˆ’çº¿
      today: "#ef4444"         // ä»Šå¤©çº¢çº¿
    },
    padDays: 3,
    leftW: 10,
    headH: 36,
    subHeadH: 24,
    barPercent: 0.65
  };

  const state = {
    tasks: [],
    zoom: 34,
    rowH: 38,
    gridStep: 1,
    hideWeekends: false
  };

  /* --- åŸºç¡€æ—¥æœŸå·¥å…· --- */
  function todayISO(){
    const d = new Date();
    return new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10);
  }
  function parseISO(s){
    if(!s) return null;
    s = String(s).trim();

    // Excel å¯èƒ½å¤åˆ¶å‡ºæ•°å­—åºåˆ—æ—¥æœŸï¼ˆåºåˆ—å·ï¼‰
    if(/^\d{5,}$/.test(s)){
      const n = parseInt(s,10);
      // Excel åºåˆ—å·é€šå¸¸ä»¥ 1899-12-30 ä¸ºåŸºå‡†ï¼ˆå…¼å®¹ 1900 é—°å¹´ bugï¼‰
      const base = new Date(Date.UTC(1899,11,30));
      const d = new Date(base.getTime() + n * 86400000);
      return new Date(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate());
    }

    // å»é™¤æ—¶é—´éƒ¨åˆ†ï¼ˆå¦‚ "2026-01-05 00:00:00"ï¼‰
    if(s.includes(" ")) s = s.split(" ")[0];

    // ç»Ÿä¸€åˆ†éš”ç¬¦
    s = s.replace(/[\/\.]/g, "-");

    // åŸç”Ÿ ISOï¼ˆå« Tï¼‰ç›´æ¥äº¤ç»™ Date è§£æ
    if(s.includes("T")) return new Date(s);

    return new Date(s + "T00:00:00");
  }
  function fmtISO(d){ return new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10); }
  function addDays(d,n){ return new Date(d.getTime()+n*MS); }
  function daysBetween(a,b){ return Math.round((b-a)/MS); }
  function isWeekend(d){ const day = d.getDay(); return day===0 || day===6; }
  function uid(){ return Math.random().toString(36).slice(2); }

  /* --- æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ --- */
  function defaultTasks(){
    const base = parseISO(todayISO());
    return [
      { id: uid(), name: "é¡¹ç›®å¯åŠ¨ä¼š", start: fmtISO(base), end: fmtISO(addDays(base, 2)), gap: 0 },
      { id: uid(), name: "éœ€æ±‚è°ƒç ”ä¸åˆ†æ", start: fmtISO(addDays(base, 3)), end: fmtISO(addDays(base, 10)), gap: 0 },
      { id: uid(), name: "ç³»ç»Ÿæ¶æ„è®¾è®¡", start: fmtISO(addDays(base, 10)), end: fmtISO(addDays(base, 18)), gap: 10 },
      { id: uid(), name: "æ¨¡å—å¼€å‘é˜¶æ®µ", start: fmtISO(addDays(base, 15)), end: fmtISO(addDays(base, 35)), gap: 0 },
      { id: uid(), name: "é›†æˆæµ‹è¯•", start: fmtISO(addDays(base, 36)), end: fmtISO(addDays(base, 42)), gap: 0 }
    ];
  }

  // è®¡ç®—æ—¥æœŸçš„ X åæ ‡ï¼ˆæ ¸å¿ƒï¼šå¤„ç†éšè—å‘¨æœ«é€»è¾‘ï¼‰
  function getX(date, minDate) {
    const totalDays = daysBetween(minDate, date);
    if (!state.hideWeekends) {
      return config.leftW + totalDays * state.zoom;
    }
    
    // éšè—å‘¨æœ«æ¨¡å¼ï¼šè®¡ç®— minDate åˆ° date ä¹‹é—´çš„å·¥ä½œæ—¥å¤©æ•°
    let workDays = 0;
    let curr = new Date(minDate);
    // ç®€å•å¾ªç¯è®¡ç®—ï¼ˆä¸ºäº†å‡†ç¡®æ€§ï¼Œä¸ä½¿ç”¨å…¬å¼ï¼‰
    while (curr < date) {
      if (!isWeekend(curr)) workDays++;
      curr = addDays(curr, 1);
    }
    // å¦‚æœç›®æ ‡æ—¥æœŸæœ¬èº«æ˜¯å‘¨æœ«ï¼Œå®ƒåº”è¯¥å åœ¨å‰ä¸€ä¸ªå‘¨äº”çš„ä½ç½®ï¼ˆè§†è§‰ä¸Šï¼‰
    // æˆ–è€…æˆ‘ä»¬ç®€å•åœ°ä¸å¢åŠ  X
    return config.leftW + workDays * state.zoom;
  }

  // ä¿®æ­£ä»»åŠ¡æ•°æ®
  function normalizeTask(t) {
    if (!t.start || !t.end) {
      const base = parseISO(todayISO());
      t.start = fmtISO(base); t.end = fmtISO(addDays(base, 5));
    }
    const s = parseISO(t.start), e = parseISO(t.end);
    if (s > e) t.end = t.start;
    t.gap = Number(t.gap)||0;
    t._dur = Math.max(1, daysBetween(s, e));
    return t;
  }

  // è®¡ç®—å¹¶æ˜¾ç¤ºæ€»å·¥æœŸï¼ˆæŒ‰æœ€æ—©å¼€å§‹ ~ æœ€æ™šç»“æŸçš„è‡ªç„¶æ—¥è·¨åº¦ï¼›ä¸å½“å‰ä»»åŠ¡æ¡å®½åº¦è®¡ç®—ä¿æŒä¸€è‡´ï¼‰
  function updateTotalDuration(minTaskStart, maxTaskEnd) {
    const durEl = $("totalDuration");
    const rangeEl = $("totalRange");
    if (!durEl) return;

    if (!minTaskStart || !maxTaskEnd || isNaN(minTaskStart.getTime()) || isNaN(maxTaskEnd.getTime())) {
      durEl.textContent = "â€”";
      if (rangeEl) rangeEl.textContent = "";
      return;
    }

    const spanDays = Math.max(0, daysBetween(minTaskStart, maxTaskEnd));
    durEl.textContent = `${spanDays} å¤©`;
    if (rangeEl) rangeEl.textContent = `(${fmtISO(minTaskStart)} ~ ${fmtISO(maxTaskEnd)})`;
  }


  /* --- æ¸²æŸ“åˆ—è¡¨ DOM --- */
  function renderRows() {
    const box = $("rows");
    box.innerHTML = "";
    state.tasks.forEach((t, idx) => {
      normalizeTask(t);
      const row = document.createElement("div");
      row.className = "task-row";
      row.innerHTML = `
        <div class="row-top">
          <span class="row-idx">${idx+1}</span>
          <input class="name" value="${t.name}" placeholder="ä»»åŠ¡åç§°" />
        </div>
        <div class="row-detail">
          <div class="field-group"><label>å¼€å§‹</label><input type="date" class="i-s" value="${t.start}"></div>
          <div class="field-group"><label>ç»“æŸ</label><input type="date" class="i-e" value="${t.end}"></div>
          <div class="field-group"><label>å·¥æœŸ</label><input type="number" class="i-d" min="1" value="${t._dur}"></div>
          <div class="field-group"><label>è¡Œè·</label><input type="number" class="i-g" min="0" value="${t.gap}"></div>
          <button class="btn-del-row" title="åˆ é™¤">âœ•</button>
        </div>
      `;
      
      const update = () => {
        t.name = row.querySelector(".name").value;
        t.start = row.querySelector(".i-s").value;
        t.end = row.querySelector(".i-e").value;
        t.gap = Number(row.querySelector(".i-g").value);
        renderChart();
      };

      row.querySelector(".name").oninput = update;
      row.querySelector(".i-s").onchange = update;
      row.querySelector(".i-e").onchange = update;
      row.querySelector(".i-g").onchange = update;
      row.querySelector(".i-d").onchange = (e) => {
        const d = Math.max(1, Number(e.target.value));
        t.end = fmtISO(addDays(parseISO(t.start), d));
        row.querySelector(".i-e").value = t.end;
        update();
      };
      row.querySelector(".btn-del-row").onclick = () => {
        if(confirm("ç¡®è®¤åˆ é™¤ï¼Ÿ")) { state.tasks.splice(idx,1); renderAll(); }
      };
      
      box.appendChild(row);
    });
  }

  /* --- æ¸²æŸ“ SVG --- */
  function el(tag, attrs={}) {
    const n = document.createElementNS("http://www.w3.org/2000/svg", tag);
    for (const k in attrs) n.setAttribute(k, attrs[k]);
    return n;
  }
  function svgTxt(str, x, y, size, color, weight="normal") {
    const t = el("text", {x, y, fill:color, "font-size":size, "font-weight":weight, "font-family":"var(--font-sans)"});
    t.textContent = str;
    return t;
  }

  function renderChart() {
    // 1. è¯»å–é…ç½®
    state.zoom = Number($("zoom").value);
    state.rowH = Number($("rowH").value);
    state.hideWeekends = $("hideWeekends").checked;
    const showWeeks = $("showWeeks").checked;
    
    // 2. ç¡®å®šæ—¶é—´èŒƒå›´ï¼ˆä»»åŠ¡çœŸå®èŒƒå›´ï¼‰
    let minT = null, maxT = null;
    state.tasks.forEach(t => {
      const s = parseISO(t.start), e = parseISO(t.end);
      if(!minT || s < minT) minT = s;
      if(!maxT || e > maxT) maxT = e;
    });

    // ä»»åŠ¡ä¸ºç©ºæ—¶ç»™ä¸€ä¸ªé»˜è®¤èŒƒå›´
    const minTask = minT ? new Date(minT) : parseISO(todayISO());
    const maxTask = maxT ? new Date(maxT) : addDays(minTask, 10);

    // æ˜¾ç¤ºæ€»å·¥æœŸï¼ˆä¸å—æ˜¾ç¤ºè£å‰ªå½±å“ï¼‰
    updateTotalDuration(minTask, maxTask);

    // å›¾è¡¨æ¸²æŸ“èŒƒå›´ï¼šå…ˆæŒ‰ä»»åŠ¡èŒƒå›´ï¼Œå†åº”ç”¨è£å‰ª
    minT = minTask;
    maxT = maxTask;

    // åº”ç”¨æ‰‹åŠ¨è£å‰ªèŒƒå›´
    const userStart = parseISO($("viewStart").value);
    const userEnd = parseISO($("viewEnd").value);
    if(userStart) minT = userStart;
    if(userEnd && userEnd > minT) maxT = userEnd;

    // å¢åŠ ä¸€ç‚¹ padding
    const renderMin = addDays(minT, -config.padDays);
    const renderMax = addDays(maxT, config.padDays);
    const totalDays = daysBetween(renderMin, renderMax);

    // 3. è®¡ç®—é«˜åº¦å’Œå®½åº¦
    let currentY = config.headH + config.subHeadH;
    const taskYs = state.tasks.map(t => {
      const y = currentY;
      currentY += state.rowH + (t.gap||0);
      return y;
    });
    
    // è®¡ç®—æ€»å®½: é€šè¿‡æ¨¡æ‹Ÿæœ€åä¸€ä¸ªç‚¹çš„åæ ‡
    const chartW = getX(renderMax, renderMin) + 200; 
    const chartH = Math.max(currentY + 20, 300);

    const svg = $("svg");
    svg.innerHTML = "";
    svg.setAttribute("width", chartW);
    svg.setAttribute("height", chartH);
    svg.setAttribute("viewBox", `0 0 ${chartW} ${chartH}`);

    // èƒŒæ™¯
    svg.appendChild(el("rect", {x:0,y:0,width:chartW,height:chartH,fill:"#ffffff"}));

    // å®šä¹‰æ ·å¼
    const defs = el("defs");
    // è“è‰²æ¸å˜æ¡
    const lg = el("linearGradient", {id:"barGrad", x1:"0", y1:"0", x2:"0", y2:"1"});
    lg.appendChild(el("stop", {offset:"0%", "stop-color":config.colors.barStart}));
    lg.appendChild(el("stop", {offset:"100%", "stop-color":config.colors.barEnd}));
    defs.appendChild(lg);
    // é˜´å½±
    const flt = el("filter", {id:"shadow", x:"-20%", y:"-20%", width:"140%", height:"140%"});
    flt.innerHTML = `<feDropShadow dx="1" dy="2" stdDeviation="2" flood-color="#000" flood-opacity="0.15"/>`;
    defs.appendChild(flt);
    svg.appendChild(defs);

    // 4. ç»˜åˆ¶ç½‘æ ¼ä¸æ—¶é—´è½´
    const axisY = config.headH + config.subHeadH;
    
    // ç»˜åˆ¶æ‰€æœ‰å¤©ï¼ˆæ ¹æ® hideWeekends è·³è¿‡ï¼‰
    let lastMonth = -1;
    
    for (let d=0; d<=totalDays; d++) {
      const curr = addDays(renderMin, d);
      // å¦‚æœéšè—å‘¨æœ«ä¸”å½“å‰æ˜¯å‘¨æœ«ï¼Œåˆ™è·³è¿‡ç»˜åˆ¶
      if (state.hideWeekends && isWeekend(curr)) continue;
      
      const x = getX(curr, renderMin);
      const dayNum = curr.getDate();
      const isMon = curr.getDay()===1;
      const isWe = isWeekend(curr);

      // ç«–çº¿
      const lineStroke = (isMon && showWeeks) ? config.colors.gridWeek : config.colors.grid;
      svg.appendChild(el("line", {x1:x,y1:axisY,x2:x,y2:chartH, stroke:lineStroke, "stroke-width":1}));
      
      // å‘¨æœ«èƒŒæ™¯æ¡ (å¦‚æœä¸éšè—)
      if (!state.hideWeekends && isWe) {
        svg.appendChild(el("rect", {x:x, y:axisY, width:state.zoom, height:chartH-axisY, fill:config.colors.gridWeekend}));
      }

      // æ—¥æœŸæ–‡å­—
      // åªæœ‰ç©ºé—´è¶³å¤Ÿæˆ–æŸäº›ç‰¹å®šæ—¥æœŸæ‰æ˜¾ç¤º
      if (state.zoom > 24 || dayNum === 1 || dayNum % 2 === 0) {
        svg.appendChild(svgTxt(dayNum, x+4, axisY-6, 11, config.colors.text));
      }
      
      // å‘¨æ–‡å­—
      if (showWeeks && isMon) {
        svg.appendChild(svgTxt("å‘¨ä¸€", x+4, axisY-18, 10, config.colors.textMain, "bold"));
      }

      // æœˆä»½å¤„ç† (ç®€åŒ–ç‰ˆï¼šåªåœ¨æ¯æœˆ1å·æˆ–ç¬¬ä¸€å¤©ç»˜åˆ¶)
      if (curr.getMonth() !== lastMonth) {
        svg.appendChild(el("line", {x1:x, y1:0, x2:x, y2:config.headH, stroke:config.colors.headerLine}));
        svg.appendChild(svgTxt(`${curr.getFullYear()}-${curr.getMonth()+1}æœˆ`, x+6, 24, 14, config.colors.textMain, "bold"));
        lastMonth = curr.getMonth();
      }
    }
    
    // è¡¨å¤´æ¨ªçº¿
    svg.appendChild(el("line", {x1:0,y1:config.headH,x2:chartW,y2:config.headH,stroke:config.colors.headerLine}));
    svg.appendChild(el("line", {x1:0,y1:axisY,x2:chartW,y2:axisY,stroke:config.colors.headerLine}));
    
    // 5. ç»˜åˆ¶ä»»åŠ¡æ¡
    state.tasks.forEach((t, i) => {
      const s = parseISO(t.start);
      const e = parseISO(t.end);
      
      // èŒƒå›´å¤–ä¸ç»˜åˆ¶
      if (e < renderMin || s > renderMax) return;

      const y = taskYs[i];
      const h = state.rowH * config.barPercent;
      const yBar = y + (state.rowH - h)/2;
      
      // è¡Œè¾…åŠ©çº¿
      svg.appendChild(el("line", {x1:0, y1:y+state.rowH, x2:chartW, y2:y+state.rowH, stroke:config.colors.grid}));

      // è®¡ç®—æ¡çš„èµ·æ­¢ X
      // æ³¨æ„ï¼šå¦‚æœ s æ˜¯å‘¨æœ«ä¸”éšè—äº†ï¼ŒgetX ä¼šè®©å®ƒé é½å‘¨äº”è¿˜æ˜¯å‘¨ä¸€ï¼Ÿ
      // æˆ‘ä»¬çš„ getX é€»è¾‘æ˜¯è®¡ç®— min åˆ° s çš„å·¥ä½œæ—¥æ•°ã€‚
      let x1 = getX(s, renderMin);
      // è®¡ç®—å®½åº¦çš„é€»è¾‘ï¼šä¸èƒ½ç®€å•ç”¨ daysBetween * zoomï¼Œå› ä¸ºä¸­é—´å¯èƒ½è·¨è¶Šäº†è¢«éšè—çš„å‘¨æœ«
      // åº”è¯¥æ˜¯ getX(e) - getX(s) + zoom (åŒ…å«æœ€åä¸€å¤©)
      // ä½†ç”±äº e å¯èƒ½æ˜¯å‘¨æœ«ï¼Œéœ€è¦å¾®è°ƒ
      let x2 = getX(addDays(e, 1), renderMin); 
      
      let w = Math.max(4, x2 - x1);
      // è§†è§‰å¾®è°ƒï¼šæ¡ä¹‹é—´ç•™ä¸€ç‚¹ç¼éš™
      w -= 2; 

      const g = el("g", {style:"cursor:pointer"});
      const rect = el("rect", {
        x:x1, y:yBar, width:w, height:h, rx:4, 
        fill:"url(#barGrad)", stroke:config.colors.barBorder, "stroke-width":1,
        filter:"url(#shadow)"
      });
      g.appendChild(rect);

      // æ–‡æœ¬
      const labelX = w > 60 ? x1+6 : x1+w+6;
      const labelColor = w > 60 ? "#fff" : config.colors.textMain;
      g.appendChild(svgTxt(t.name, labelX, yBar+h/2+4, 12, labelColor, "500"));

      svg.appendChild(g);
      
      // ç®€å•çš„æ‹–æ‹½ç»‘å®š (é€»è¾‘ç®€åŒ–ï¼šåªæ›´æ–°æ•°æ®ï¼Œè§¦å‘é‡ç»˜)
      bindDrag(rect, t);
    });

    $("statusPill").textContent = `æ˜¾ç¤ºèŒƒå›´: ${fmtISO(renderMin)} ~ ${fmtISO(renderMax)}`;
  }

  function bindDrag(rect, t) {
    rect.addEventListener("pointerdown", (e) => {
      e.preventDefault();
      const startX = e.clientX;
      const s0 = parseISO(t.start);
      const e0 = parseISO(t.end);
      
      const onMove = (ev) => {
        const diffPx = ev.clientX - startX;
        const diffDays = Math.round(diffPx / state.zoom);
        if(diffDays === 0) return;
        // æ‹–æ‹½æ—¶ä¸è€ƒè™‘å·¥ä½œæ—¥é€»è¾‘ï¼Œç®€å•å¹³ç§»æ—¥æœŸ
        t.start = fmtISO(addDays(s0, diffDays));
        t.end = fmtISO(addDays(e0, diffDays));
        renderChart(); // å®æ—¶é‡ç»˜
        renderRows(); // åŒæ­¥å·¦ä¾§
      };
      const onUp = () => {
        window.removeEventListener("pointermove", onMove);
        window.removeEventListener("pointerup", onUp);
      };
      window.addEventListener("pointermove", onMove);
      window.addEventListener("pointerup", onUp);
    });
  }

  /* --- å¯¼å‡º --- */
  function exportPNG() {
    const svg = $("svg");
    const xml = new XMLSerializer().serializeToString(svg);
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");
    const img = new Image();
    
    // 2x é«˜æ¸…å¯¼å‡º
    const scale = 2;
    canvas.width = svg.getAttribute("width") * scale;
    canvas.height = svg.getAttribute("height") * scale;
    
    img.onload = () => {
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.scale(scale, scale);
      ctx.drawImage(img, 0, 0);
      
      canvas.toBlob(blob => {
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `Gantt_Export_${fmtISO(new Date())}.png`;
        a.click();
      });
    };
    img.src = "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(xml)));
  }

  function renderAll() { renderRows(); renderChart(); }
  
  // Events
  $("btnAdd").onclick = () => {
    state.tasks.push({id:uid(), name:"æ–°ä»»åŠ¡", start:fmtISO(parseISO(todayISO())), end:fmtISO(addDays(parseISO(todayISO()),5))});
    renderAll();
  };
  $("btnReset").onclick = () => { state.tasks = defaultTasks(); renderAll(); };
  $("btnClearTasks").onclick = () => {
    if(confirm("ç¡®è®¤æ¸…ç©ºä»»åŠ¡æ¸…å•ï¼Ÿ")) { state.tasks = []; renderAll(); }
  };
  $("btnPNG").onclick = exportPNG;
  
  // --- TSV å¯¼å…¥é€»è¾‘ï¼ˆé¡¹ç›® | å¼€å§‹æ—¥æœŸ | å·¥æœŸï¼‰ ---
  $("btnImport").onclick = () => {
    const txt = $("tsvIn").value.trim();
    if(!txt) return alert("è¯·å…ˆç²˜è´´ Excel å†…å®¹");

    // å…¼å®¹ Windows / macOS / Linux æ¢è¡Œ
    const lines = txt.split(/\r?\n/);
    let count = 0;

    lines.forEach(line => {
      // 1. æ¸…ç†æ•°æ®ï¼šå»é™¤é¦–å°¾ç©ºç™½ï¼Œå¤„ç† Excel å¯èƒ½å¸¦çš„å¼•å·
      line = line.trim().replace(/^"|"$/g, '');
      if(!line) return;

      // 2. åˆ†å‰²åˆ—ï¼šæ”¯æŒ Tab(Excelé»˜è®¤) æˆ– è‹±æ–‡é€—å·
      const cols = line.split(/[\t,]/).map(s => s.trim());

      // è·³è¿‡æ˜¾è€Œæ˜“è§çš„è¡¨å¤´
      if (cols[0] && cols[0].match(/^(é¡¹ç›®|ä»»åŠ¡|Task|åç§°|Name)/i)) return;

      // è‡³å°‘éœ€è¦ï¼šé¡¹ç›® + å¼€å§‹æ—¥æœŸ
      if (cols.length < 2) return;

      const name = cols[0] || "æœªå‘½å";
      const startStr = cols[1] || "";
      const third = (cols[2] ?? "").trim(); // å·¥æœŸ æˆ– ç»“æŸæ—¥æœŸï¼ˆå…¼å®¹ï¼‰

      // å¼€å§‹æ—¥æœŸå¿…é¡»ä¸ºæ—¥æœŸæ ¼å¼
      if (!(/[-\/\.]/.test(startStr) || /^\d{5,}$/.test(startStr))) return;
      const s = parseISO(startStr);
      if (!s || isNaN(s.getTime())) return;

      let e = null;

      // ç¬¬ä¸‰åˆ—ä¼˜å…ˆæŒ‰å·¥æœŸè§£æï¼›å¦‚æ˜æ˜¾ä¸ºæ—¥æœŸåˆ™æŒ‰ç»“æŸæ—¥æœŸå…¼å®¹å¤„ç†
      if (third && /[-\/\.]/.test(third)) {
        const tmp = parseISO(third);
        if (tmp && !isNaN(tmp.getTime())) e = tmp;
      } else {
        const dur = Math.max(1, parseInt(third) || 1);
        e = addDays(s, dur - 1);
      }

      if (!e || isNaN(e.getTime())) return;

      state.tasks.push({
        id: uid(),
        name,
        start: fmtISO(s),
        end: fmtISO(e),
        gap: 0
      });
      count++;
    });

    if(count > 0) {
      renderAll();
      alert(`æˆåŠŸå¯¼å…¥ ${count} æ¡ä»»åŠ¡`);
      $("tsvIn").value = "";
    } else {
      alert("æœªè¯†åˆ«åˆ°æœ‰æ•ˆæ•°æ®ï¼Œè¯·æ£€æŸ¥æ ¼å¼ï¼šé¡¹ç›®<Tab>å¼€å§‹æ—¥æœŸ<Tab>å·¥æœŸ(å¤©)");
    }
  };


  // ç»‘å®šæ‰€æœ‰ Input äº‹ä»¶
  ["zoom","rowH","hideWeekends","showWeeks","viewStart","viewEnd"].forEach(k => {
    $(k).oninput = renderChart;
  });

  // Init
  state.tasks = defaultTasks();
  renderAll();
})();
</script>
</body>
</html>