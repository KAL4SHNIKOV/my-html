<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Visual N-Back</title>
  <style>
    :root {
      --bg: #111827;
      --panel: #1f2937;
      --text: #f3f4f6;
      --accent: #6366f1; /* Indigo */
      --active-cell: #818cf8;
      --grid-bg: #374151;
      --border: #374151;
    }
    body { margin: 0; font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; overflow: hidden;}

    .sidebar { width: 280px; background: var(--panel); border-right: 1px solid var(--border); padding: 24px; display: flex; flex-direction: column; z-index: 10; transition: transform 0.3s; }
    
    .main { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
    
    /* Config UI */
    h1 { font-size: 1.2rem; margin: 0 0 20px; color: white; letter-spacing: 1px; }
    label { display: block; font-size: 0.8rem; color: #9ca3af; margin-bottom: 6px; }
    input { background: #111827; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 6px; width: 100%; box-sizing: border-box; font-family: monospace; margin-bottom: 16px; }
    
    button.primary { background: var(--accent); color: white; border: none; padding: 12px; width: 100%; border-radius: 6px; font-weight: bold; cursor: pointer; }
    button.primary:hover { filter: brightness(1.1); }
    button.primary:disabled { opacity: 0.5; cursor: not-allowed; }
    button.stop { background: transparent; border: 1px solid #ef4444; color: #ef4444; margin-top: 10px; width: 100%; padding: 8px; border-radius: 6px; cursor: pointer; }

    /* The Grid */
    .n-back-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      background: #1f2937;
      padding: 12px;
      border-radius: 16px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }
    .cell {
      width: 80px; height: 80px;
      background: #374151;
      border-radius: 12px;
      transition: all 0.1s;
    }
    .cell.active {
      background: white;
      box-shadow: 0 0 20px white;
      transform: scale(0.95);
    }

    /* Controls Overlay */
    .controls-overlay {
      margin-top: 40px;
      display: flex;
      gap: 20px;
    }
    .key-btn {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      width: 140px; height: 80px;
      border: 2px solid #4b5563;
      border-radius: 12px;
      color: #9ca3af;
      font-weight: 600;
      transition: all 0.1s;
    }
    .key-btn.pressed { transform: translateY(4px); background: #374151; border-color: white; color: white; }
    .kbd { font-size: 1.5rem; margin-bottom: 4px; color: white; }
    
    .status-bar { position: absolute; top: 20px; color: #6b7280; font-family: monospace; }
    .n-indicator { font-size: 4rem; position: absolute; top: 50px; left: 50px; opacity: 0.05; font-weight: 900; pointer-events: none; }
    
    /* Stats */
    .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; border-bottom: 1px solid #374151; padding-bottom: 8px; }
    .stat-val { font-family: monospace; color: white; }
  </style>
</head>
<body>

<aside class="sidebar">
  <h1>N-Back Task</h1>
  
  <label>N Level (Back)</label>
  <input type="number" id="nValue" value="2" min="1">
  
  <label>Total Trials</label>
  <input type="number" id="nTrials" value="30" min="10">
  
  <label>Target Ratio (0-1)</label>
  <input type="number" id="ratio" value="0.3" step="0.1">

  <label>Speed (ms per item)</label>
  <input type="number" id="speed" value="1000">

  <button class="primary" id="startBtn">START</button>
  <button class="stop" id="stopBtn" disabled>STOP</button>
  
  <div style="margin-top: 30px;">
    <h3 style="font-size:0.8rem; color:#6b7280; text-transform:uppercase;">Live Stats</h3>
    <div class="stat-row"><span>Hits</span> <span class="stat-val" id="hits">-</span></div>
    <div class="stat-row"><span>False Alarms</span> <span class="stat-val" id="fas">-</span></div>
    <div class="stat-row"><span>Accuracy</span> <span class="stat-val" id="acc">-</span></div>
  </div>
  
  <button id="dlBtn" disabled style="margin-top:auto; background:none; border:none; color:#6b7280; text-decoration:underline; cursor:pointer;">Download CSV</button>
</aside>

<main class="main">
  <div class="n-indicator" id="bgN">N=2</div>
  <div class="status-bar" id="status">Press START to begin</div>

  <div class="n-back-grid" id="grid">
    </div>

  <div class="controls-overlay">
    <div class="key-btn" id="btnNon">
      <span class="kbd">D</span>
      <span>Non-Match</span>
    </div>
    <div class="key-btn" id="btnMatch">
      <span class="kbd">K</span>
      <span>Match</span>
    </div>
  </div>
</main>

<script>
  const el = id => document.getElementById(id);
  const sleep = ms => new Promise(r => setTimeout(r, ms));

  // Setup Grid
  const grid = el('grid');
  const cells = [];
  for(let i=0; i<9; i++) {
    const div = document.createElement('div');
    div.className = 'cell';
    grid.appendChild(div);
    cells.push(div);
  }

  let running = false;
  let controller = null;
  let results = [];
  
  // Logic
  const getParams = () => ({
    n: Number(el('nValue').value),
    trials: Number(el('nTrials').value),
    ratio: Number(el('ratio').value),
    speed: Number(el('speed').value)
  });

  async function runSession() {
    running = true;
    results = [];
    controller = new AbortController();
    const cfg = getParams();
    
    // UI Update
    el('startBtn').disabled = true;
    el('stopBtn').disabled = false;
    el('dlBtn').disabled = true;
    el('bgN').textContent = `N=${cfg.n}`;
    el('status').textContent = `Memorize position ${cfg.n} steps back`;
    
    // Generate Sequence
    const seq = [];
    for(let i=0; i<cfg.trials; i++) {
      let pos;
      let isTarget = false;
      
      // Logic for N-back targets
      if(i >= cfg.n && Math.random() < cfg.ratio) {
        pos = seq[i - cfg.n].pos;
        isTarget = true;
      } else {
        // Generate non-target (try to avoid accidental targets)
        do {
          pos = Math.floor(Math.random() * 9);
        } while (i >= cfg.n && pos === seq[i-cfg.n].pos);
      }
      seq.push({ id:i+1, pos, isTarget });
    }

    try {
      for (const trial of seq) {
        if(controller.signal.aborted) break;
        
        el('status').textContent = `Trial ${trial.id} / ${cfg.trials}`;
        
        // Flash Stimulus
        cells[trial.pos].classList.add('active');
        
        const t0 = performance.now();
        const resp = await waitForInput(cfg.speed, controller.signal);
        const t1 = performance.now();
        
        cells[trial.pos].classList.remove('active');
        
        // Analyze
        let acc = 0; // 0=wrong, 1=correct
        let type = 'Miss';
        
        if (trial.isTarget) {
           if (resp === 'match') { acc = 1; type = 'Hit'; }
           else if (resp === 'non') { acc = 0; type = 'Miss'; }
           else { acc = 0; type = 'Miss'; } // Timeout count as miss for target
        } else {
           if (resp === 'non') { acc = 1; type = 'CR'; } // Correct Rejection
           else if (resp === 'match') { acc = 0; type = 'FA'; } // False Alarm
           else { acc = 1; type = 'CR'; } // Timeout implies non-match logic (usually)
           // Note: visual N-back usually requires button press for match only, 
           // but here we support D/K forced choice.
           // If user didn't press anything in forced choice, it's a timeout error.
           if (!resp) acc = 0; 
        }

        results.push({
            trial: trial.id,
            isTarget: trial.isTarget,
            resp: resp || 'timeout',
            acc: acc,
            rt: resp ? Math.round(t1 - t0) : 0
        });

        updateStats();
        
        // ISI (Inter-Stimulus Interval) - Short blank
        await sleep(200);
      }
    } catch(e) { console.log("Stopped"); }
    
    finish();
  }

  function finish() {
    running = false;
    el('startBtn').disabled = false;
    el('stopBtn').disabled = true;
    el('dlBtn').disabled = false;
    el('status').textContent = "Session Complete";
    cells.forEach(c => c.classList.remove('active'));
  }

  function updateStats() {
    if(!results.length) return;
    const hits = results.filter(r => r.isTarget && r.acc).length;
    const targets = results.filter(r => r.isTarget).length;
    const fas = results.filter(r => !r.isTarget && !r.acc && r.resp !== 'timeout').length;
    
    el('hits').textContent = `${hits}/${targets}`;
    el('fas').textContent = fas;
    const totalAcc = Math.round((results.filter(r=>r.acc).length / results.length)*100);
    el('acc').textContent = totalAcc + '%';
  }

  function waitForInput(ms, signal) {
    return new Promise(resolve => {
        let timer;
        const handler = (e) => {
            if(e.code === 'KeyD') { trigger('non'); resolve('non'); }
            if(e.code === 'KeyK') { trigger('match'); resolve('match'); }
            if(e.code === 'Escape') { 
                if(controller) controller.abort(); 
                resolve(null); 
            }
        };
        
        const trigger = (type) => {
            const btn = type === 'non' ? el('btnNon') : el('btnMatch');
            btn.classList.add('pressed');
            setTimeout(()=>btn.classList.remove('pressed'), 100);
            cleanup();
        };

        const cleanup = () => {
            clearTimeout(timer);
            window.removeEventListener('keydown', handler);
        };

        window.addEventListener('keydown', handler);
        timer = setTimeout(() => { cleanup(); resolve(null); }, ms);
        signal.addEventListener('abort', () => { cleanup(); resolve(null); });
    });
  }

  el('startBtn').onclick = runSession;
  el('stopBtn').onclick = () => controller && controller.abort();
  el('dlBtn').onclick = () => {
      const csv = "Trial,IsTarget,Resp,Acc,RT\n" + results.map(r => `${r.trial},${r.isTarget},${r.resp},${r.acc},${r.rt}`).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'nback_data.csv'; a.click();
  };

</script>
</body>
</html>
