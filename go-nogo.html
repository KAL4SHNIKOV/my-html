<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Go/No-Go Task | Cognitive Lab</title>
  <style>
    :root {
      --bg: #111827;
      --panel: #1f2937;
      --text: #f3f4f6;
      --muted: #9ca3af;
      --go-color: #34d399; /* Green */
      --nogo-color: #3b82f6; /* Blue - often used instead of red to avoid stop-sign bias, but config allows change */
      --border: #374151;
      --font-mono: ui-monospace, SFMono-Regular, Menlo, monospace;
      --font-sans: system-ui, -apple-system, sans-serif;
    }
    body { margin: 0; font-family: var(--font-sans); background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

    .app-shell { display: flex; height: 100%; }
    .sidebar { width: 320px; background: var(--panel); border-right: 1px solid var(--border); padding: 24px; display: flex; flex-direction: column; z-index: 10; transition: transform 0.3s; }
    .main-stage { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; background: #000; flex-direction: column; }
    
    /* When running, dim sidebar */
    body.running .sidebar { filter: brightness(0.4); pointer-events: none; }
    body.running .main-stage { cursor: none; }

    h1 { font-size: 1.1rem; margin: 0 0 24px 0; color: #fff; font-weight: 700; display: flex; justify-content: space-between; align-items: center; }
    .badge { background: #374151; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; color: #9ca3af; }
    
    /* Form */
    .field { margin-bottom: 16px; }
    label { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--muted); margin-bottom: 6px; }
    input { background: #111827; border: 1px solid var(--border); color: white; padding: 8px; border-radius: 6px; width: 100%; box-sizing: border-box; font-family: var(--font-mono); }
    
    button { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; margin-top: 8px; }
    .btn-start { background: var(--go-color); color: #064e3b; }
    .btn-start:hover { filter: brightness(1.1); }
    .btn-stop { background: #ef4444; color: white; opacity: 0.5; }
    .btn-stop:not(:disabled) { opacity: 1; }

    /* Stats Grid */
    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 24px; }
    .stat-box { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; text-align: center; }
    .stat-val { font-size: 1.2rem; font-weight: 700; font-family: var(--font-mono); }
    .stat-lbl { font-size: 0.7rem; color: var(--muted); margin-top: 4px; }
    .alert-val { color: #f87171; } /* For False Alarms */

    /* Stage Elements */
    .stimulus { width: 150px; height: 150px; border-radius: 50%; display: none; box-shadow: 0 0 40px rgba(0,0,0,0.5); }
    .feedback-icon { position: absolute; font-size: 2rem; margin-top: 200px; opacity: 0.7; }
    .fixation { color: #4b5563; font-size: 40px; }

    .instructions { text-align: center; color: var(--muted); max-width: 400px; line-height: 1.7; }
    .key-cap { border: 1px solid #4b5563; padding: 2px 8px; border-radius: 4px; color: #e5e7eb; font-size: 0.9em; }

  </style>
</head>
<body>

<div class="app-shell">
  <aside class="sidebar">
    <h1>Go/No-Go <span class="badge">V2.0</span></h1>
    
    <div class="field">
      <label>Trial Count</label>
      <input type="number" id="nTrials" value="50">
    </div>
    <div class="field">
      <label>Go Ratio (0-1)</label>
      <input type="number" id="goRatio" value="0.75" step="0.05">
    </div>
    <div class="field">
      <label>Duration (ms)</label>
      <input type="number" id="stimMs" value="600">
    </div>

    <button id="startBtn" class="btn-start">START TASK</button>
    <button id="stopBtn" class="btn-stop" disabled>ABORT</button>

    <div class="stats-grid">
      <div class="stat-box">
        <div class="stat-val" id="hitRate">0%</div>
        <div class="stat-lbl">Go Hits</div>
      </div>
      <div class="stat-box">
        <div class="stat-val alert-val" id="faRate">0%</div>
        <div class="stat-lbl">False Alarms</div>
      </div>
      <div class="stat-box" style="grid-column: 1 / -1">
        <div class="stat-val" id="avgRt">0 ms</div>
        <div class="stat-lbl">Mean Reaction Time</div>
      </div>
    </div>
    
    <div style="margin-top:auto; font-size:0.75rem; color:#666; text-align:center;">
      Press <a href="#" style="color:#888;" id="dlCsv">Download CSV</a> after run
    </div>
  </aside>

  <main class="main-stage">
    <div class="instructions" id="instructions">
      <p style="font-size:1.2rem; color:white;">Ready?</p>
      <p><span style="color:var(--go-color); font-weight:bold;">Green Circle</span> = Press <span class="key-cap">Space</span> (Go)</p>
      <p><span style="color:var(--nogo-color); font-weight:bold;">Blue Circle</span> = Do Nothing (No-Go)</p>
      <p style="margin-top:20px; font-size:0.9rem;">Speed and accuracy are both important.</p>
    </div>

    <div class="fixation" id="fixation" style="display:none;">+</div>
    <div class="stimulus" id="stimulus"></div>
    <div class="feedback-icon" id="feedback"></div>
  </main>
</div>

<script>
  const el = id => document.getElementById(id);
  const sleep = ms => new Promise(r => setTimeout(r, ms));

  let state = {
    running: false,
    results: [],
    controller: null
  };

  // UI Updates
  const updateUI = () => {
    if (state.results.length === 0) return;
    
    const goTrials = state.results.filter(r => r.isGo);
    const nogoTrials = state.results.filter(r => !r.isGo);
    
    // Hit: Go trial + Response
    const hits = goTrials.filter(r => r.responded).length;
    // FA: NoGo trial + Response
    const fas = nogoTrials.filter(r => r.responded).length;
    
    const hitRate = goTrials.length ? (hits / goTrials.length * 100) : 0;
    const faRate = nogoTrials.length ? (fas / nogoTrials.length * 100) : 0;
    
    // RT only for Hits
    const validRts = goTrials.filter(r => r.responded).map(r => r.rt);
    const avgRt = validRts.length ? (validRts.reduce((a,b)=>a+b,0) / validRts.length) : 0;

    el('hitRate').textContent = Math.round(hitRate) + '%';
    el('faRate').textContent = Math.round(faRate) + '%';
    el('avgRt').textContent = Math.round(avgRt) + ' ms';
  };

  // Trial Runner
  async function runTask() {
    if(state.running) return;
    
    // Init
    state.running = true;
    state.results = [];
    state.controller = new AbortController();
    
    el('startBtn').disabled = true;
    el('stopBtn').disabled = false;
    el('instructions').style.display = 'none';
    document.body.classList.add('running');
    
    const cfg = {
      n: Number(el('nTrials').value),
      ratio: Number(el('goRatio').value),
      dur: Number(el('stimMs').value)
    };

    try {
      for(let i=0; i<cfg.n; i++) {
        if(state.controller.signal.aborted) break;

        // 1. ITI / Fixation
        el('stimulus').style.display = 'none';
        el('fixation').style.display = 'block';
        el('feedback').textContent = '';
        
        // Random ITI 800-1200ms
        await sleep(800 + Math.random() * 400);
        
        if(state.controller.signal.aborted) break;

        // 2. Stimulus
        el('fixation').style.display = 'none';
        const isGo = Math.random() < cfg.ratio;
        const stim = el('stimulus');
        stim.style.display = 'block';
        stim.style.background = isGo ? 'var(--go-color)' : 'var(--nogo-color)';

        // 3. Response Window
        const tStart = performance.now();
        const resp = await waitForResponse(cfg.dur, state.controller.signal);
        const tEnd = performance.now();
        
        // 4. Record
        const responded = (resp !== null);
        const rt = responded ? (tEnd - tStart) : 0;
        
        state.results.push({
          id: i+1,
          isGo,
          responded,
          rt,
          correct: (isGo && responded) || (!isGo && !responded)
        });

        updateUI();
      }
    } catch(e) {
      console.log('Task stopped');
    } finally {
      // Cleanup
      state.running = false;
      document.body.classList.remove('running');
      el('stimulus').style.display = 'none';
      el('fixation').style.display = 'none';
      el('instructions').style.display = 'block';
      el('startBtn').disabled = false;
      el('stopBtn').disabled = true;
    }
  }

  function waitForResponse(ms, signal) {
    return new Promise(resolve => {
      let timer;
      const onKey = (e) => {
        if(e.code === 'Space') {
          cleanup();
          resolve(true); // responded
        }
        if(e.code === 'Escape') {
          cleanup();
          el('stopBtn').click();
          resolve(null);
        }
      };
      
      const cleanup = () => {
        window.removeEventListener('keydown', onKey);
        clearTimeout(timer);
      };

      window.addEventListener('keydown', onKey);
      
      timer = setTimeout(() => {
        cleanup();
        resolve(null); // timeout/no response
      }, ms);

      signal.addEventListener('abort', () => {
        cleanup();
        resolve(null);
      });
    });
  }

  // Bindings
  el('startBtn').onclick = runTask;
  el('stopBtn').onclick = () => state.controller && state.controller.abort();
  
  el('dlCsv').onclick = (e) => {
    e.preventDefault();
    if(!state.results.length) return alert('No data collected');
    const csvContent = "data:text/csv;charset=utf-8," 
      + "Trial,Type,Responded,RT,Correct\n"
      + state.results.map(r => `${r.id},${r.isGo?'GO':'NOGO'},${r.responded},${Math.round(r.rt)},${r.correct?1:0}`).join("\n");
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "go_nogo_results.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };
</script>
</body>
</html>
