<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Flanker Task | Cognitive Lab</title>
  <style>
    :root {
      --bg: #f4f5f7;
      --panel: #ffffff;
      --text: #334155;
      --accent: #2563eb;
      --accent-hover: #1d4ed8;
      --danger: #ef4444;
      --border: #e2e8f0;
      --font-mono: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
      --font-sans: system-ui, -apple-system, sans-serif;
    }
    body { margin: 0; font-family: var(--font-sans); background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
    
    /* Layout */
    .app-shell { display: flex; height: 100%; }
    .sidebar { width: 300px; background: var(--panel); border-right: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; overflow-y: auto; transition: opacity 0.3s; z-index: 2; }
    .main-stage { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; background: #0f172a; flex-direction: column; }
    
    /* Focus Mode Classes */
    body.running .sidebar { opacity: 0.1; pointer-events: none; filter: grayscale(1); }
    body.running .main-stage { cursor: none; }

    /* Typography */
    h1 { font-size: 1.2rem; margin: 0 0 20px 0; color: #0f172a; font-weight: 700; display: flex; align-items: center; gap: 8px; }
    h2 { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; margin: 24px 0 12px; }
    
    /* Controls */
    .control-group { margin-bottom: 16px; }
    label { display: block; font-size: 0.85rem; margin-bottom: 6px; font-weight: 500; }
    input[type="number"] { width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; font-family: var(--font-mono); font-size: 0.9rem; box-sizing: border-box; }
    
    .btn { width: 100%; padding: 10px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 0.95rem; }
    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover { background: var(--accent-hover); }
    .btn-primary:disabled { background: #94a3b8; cursor: not-allowed; }
    .btn-stop { background: white; border: 1px solid var(--danger); color: var(--danger); margin-top: 10px; }
    .btn-stop:disabled { opacity: 0.5; cursor: not-allowed; border-color: var(--border); color: #94a3b8; }
    
    /* Stimulus Area */
    .stimulus { font-size: 5rem; font-weight: 700; color: white; letter-spacing: 12px; user-select: none; height: 100px; line-height: 100px; }
    .fixation { font-size: 3rem; color: #64748b; position: absolute; }
    
    /* Instructions Overlay in Stage */
    .stage-overlay { text-align: center; color: #94a3b8; max-width: 400px; line-height: 1.6; }
    .key-hint { display: inline-block; padding: 4px 10px; border: 1px solid #334155; border-radius: 6px; color: #cbd5e1; font-family: var(--font-mono); font-size: 0.9rem; margin: 0 4px; }

    /* Stats Dashboard in Sidebar */
    .stat-card { background: #f8fafc; padding: 12px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 10px; }
    .stat-val { font-family: var(--font-mono); font-size: 1.1rem; font-weight: 600; color: #0f172a; }
    .stat-label { font-size: 0.75rem; color: #64748b; }
    .log-area { flex: 1; margin-top: 10px; font-family: var(--font-mono); font-size: 0.75rem; background: #f1f5f9; border: 1px solid var(--border); border-radius: 6px; padding: 10px; overflow-y: auto; white-space: pre-wrap; height: 150px; color: #475569; }

  </style>
</head>
<body>

<div class="app-shell">
  <aside class="sidebar">
    <h1>
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
      Flanker Task
    </h1>

    <div>
      <div class="control-group">
        <label>试次数 (Trials)</label>
        <input type="number" id="nTrials" value="40" min="10" max="500">
      </div>
      <div class="control-group">
        <label>一致比例 (Congruency 0-1)</label>
        <input type="number" id="ratio" value="0.5" step="0.1" min="0" max="1">
      </div>
      <div class="control-group">
        <label>刺激呈现时间 (ms)</label>
        <input type="number" id="stimMs" value="1000">
      </div>
      <div class="control-group">
        <label>间隔时间 (ITI ms)</label>
        <input type="number" id="itiMs" value="800">
      </div>
      
      <button id="startBtn" class="btn btn-primary">开始实验 (Start)</button>
      <button id="stopBtn" class="btn btn-stop" disabled>停止 (Stop)</button>
      <button id="exportBtn" class="btn" style="margin-top:10px; font-size:0.8rem; text-decoration:underline;">导出CSV数据</button>
    </div>

    <h2>实时统计</h2>
    <div class="stat-card">
      <div class="stat-val" id="accDisplay">0%</div>
      <div class="stat-label">正确率 Accuracy</div>
    </div>
    <div class="stat-card">
      <div class="stat-val"><span id="rtDisplay">0</span> <span style="font-size:0.7em; color:#999">ms</span></div>
      <div class="stat-label">平均反应时 Mean RT</div>
    </div>
    
    <h2>日志</h2>
    <div class="log-area" id="logArea">等待开始...</div>
  </aside>

  <main class="main-stage" id="stage">
    <div class="stage-overlay" id="introText">
      <p style="font-size:1.1rem; color:white; margin-bottom:20px;">任务说明</p>
      <p>屏幕将出现一排箭头，请专注于 <strong>中间</strong> 的箭头方向。</p>
      <p>向左按 <span class="key-hint">←</span> 或 <span class="key-hint">A</span></p>
      <p>向右按 <span class="key-hint">→</span> 或 <span class="key-hint">L</span></p>
      <p style="margin-top:30px; font-size:0.9rem; opacity:0.7;">点击左侧“开始实验”运行</p>
    </div>
    
    <div class="fixation" id="fixation" style="display:none;">+</div>
    <div class="stimulus" id="stimulus" style="display:none;"></div>
  </main>
</div>

<script>
// Logic core
const el = id => document.getElementById(id);
const sleep = ms => new Promise(r => setTimeout(r, ms));

// State
let running = false;
let results = [];
let abortController = null;

// Configs
const getCfg = () => ({
  n: Number(el('nTrials').value),
  ratio: Number(el('ratio').value),
  stimMs: Number(el('stimMs').value),
  itiMs: Number(el('itiMs').value)
});

// UI helpers
const setUI = (state) => {
  el('startBtn').disabled = (state === 'running');
  el('stopBtn').disabled = (state === 'idle');
  el('introText').style.display = (state === 'idle') ? 'block' : 'none';
  el('nTrials').disabled = (state === 'running');
  document.body.classList.toggle('running', state === 'running');
};

const updateStats = () => {
  const valid = results.filter(r => r.resp !== 'timeout');
  if(valid.length === 0) return;
  
  const acc = results.filter(r => r.acc).length / results.length;
  const avgRt = valid.reduce((a,b) => a + b.rt, 0) / valid.length;
  
  el('accDisplay').textContent = (acc * 100).toFixed(1) + '%';
  el('rtDisplay').textContent = Math.round(avgRt);
  el('logArea').textContent = results.slice(-5).map(r => 
    `Trial ${r.id}: ${r.cond} | ${r.acc ? 'CORRECT' : 'ERROR'} | ${r.rt}ms`
  ).join('\n');
};

// Trial Logic
async function runBlock() {
  running = true;
  results = [];
  setUI('running');
  abortController = new AbortController();
  const signal = abortController.signal;
  
  const cfg = getCfg();
  // Generate Trials
  const trialList = Array.from({length: cfg.n}, (_, i) => {
    const isCong = Math.random() < cfg.ratio;
    const center = Math.random() < 0.5 ? '<' : '>';
    const flank = isCong ? center : (center === '<' ? '>' : '<');
    const stimStr = `${flank}${flank}${center}${flank}${flank}`;
    return { id: i+1, isCong, center, stimStr };
  });

  try {
    for (const trial of trialList) {
      if(signal.aborted) break;
      
      // 1. Fixation
      el('stimulus').style.display = 'none';
      el('fixation').style.display = 'block';
      await sleep(cfg.itiMs); // Simple ITI
      
      if(signal.aborted) break;

      // 2. Stimulus & Response
      el('fixation').style.display = 'none';
      el('stimulus').textContent = trial.stimStr;
      el('stimulus').style.display = 'block';
      
      const t0 = performance.now();
      const resp = await raceResponse(cfg.stimMs, signal);
      const t1 = performance.now();
      
      // 3. Record
      const rt = Math.round(t1 - t0);
      let acc = false;
      let respKey = resp || 'timeout';
      
      if (resp) {
        if (trial.center === '<' && (resp === 'ArrowLeft' || resp.toLowerCase() === 'a')) acc = true;
        if (trial.center === '>' && (resp === 'ArrowRight' || resp.toLowerCase() === 'l')) acc = true;
      }

      results.push({
        id: trial.id,
        cond: trial.isCong ? 'Cong' : 'Incong',
        rt: (resp === null) ? 0 : rt,
        acc: acc,
        resp: respKey
      });
      
      updateStats();
      el('stimulus').style.display = 'none';
    }
  } catch (e) {
    console.log("Aborted");
  } finally {
    running = false;
    el('fixation').style.display = 'none';
    el('stimulus').style.display = 'none';
    setUI('idle');
  }
}

function raceResponse(duration, signal) {
  return new Promise(resolve => {
    let timeoutId;
    
    const handler = (e) => {
      if(['ArrowLeft','ArrowRight','a','l','A','L'].includes(e.key)) {
        cleanup();
        resolve(e.key);
      }
      if(e.key === 'Escape') {
        cleanup();
        el('stopBtn').click(); // trigger abort
        resolve(null);
      }
    };
    
    const cleanup = () => {
      window.removeEventListener('keydown', handler);
      clearTimeout(timeoutId);
    };

    window.addEventListener('keydown', handler);
    
    timeoutId = setTimeout(() => {
      cleanup();
      resolve(null); // timeout
    }, duration);
    
    // Support external abort
    signal.addEventListener('abort', () => {
      cleanup();
      resolve(null);
    });
  });
}

// Bindings
el('startBtn').onclick = runBlock;
el('stopBtn').onclick = () => { if(abortController) abortController.abort(); };

el('exportBtn').onclick = () => {
  if(!results.length) return alert("暂无数据");
  const header = "Trial,Condition,Accuracy,RT,Response\n";
  const rows = results.map(r => `${r.id},${r.cond},${r.acc ? 1 : 0},${r.rt},${r.resp}`).join('\n');
  const blob = new Blob([header + rows], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `flanker_data_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
};

</script>
</body>
</html>
