<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Task Switching Paradigm</title>
  <style>
    :root {
      --bg: #f8fafc;
      --panel: #ffffff;
      --text: #334155;
      --text-light: #94a3b8;
      --accent-blue: #3b82f6;
      --accent-orange: #f97316;
      --success: #22c55e;
      --error: #ef4444;
      --border: #e2e8f0;
    }
    body { margin: 0; font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; }
    
    /* Sidebar */
    .sidebar { width: 300px; background: var(--panel); border-right: 1px solid var(--border); padding: 24px; display: flex; flex-direction: column; transition: opacity 0.3s; z-index: 10; overflow-y: auto; }
    .sidebar.dimmed { opacity: 0.2; pointer-events: none; }
    
    h1 { font-size: 1.25rem; margin: 0 0 20px; color: #0f172a; font-weight: 700; }
    .control-group { margin-bottom: 16px; }
    label { display: block; font-size: 0.85rem; color: var(--text-light); margin-bottom: 6px; font-weight: 500; }
    input { width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; font-family: monospace; box-sizing: border-box; }
    
    .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 0.95rem; }
    .btn-primary { background: #0f172a; color: white; }
    .btn-primary:hover { background: #1e293b; }
    .btn-stop { background: #fee2e2; color: var(--error); margin-top: 12px; }
    
    /* Stats */
    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 20px; }
    .stat-card { background: #f1f5f9; padding: 12px; border-radius: 8px; text-align: center; }
    .stat-val { font-size: 1.2rem; font-weight: 700; color: #0f172a; font-family: monospace; }
    .stat-label { font-size: 0.75rem; color: var(--text-light); margin-top: 4px; }

    /* Main Stage */
    .stage { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; background: #e2e8f0; transition: background 0.3s; }
    .stage.focus { background: #cbd5e1; cursor: none; }

    /* Task Indicators (Left/Right) */
    .task-guide { position: absolute; top: 50%; transform: translateY(-50%); padding: 20px; border-radius: 12px; text-align: center; width: 120px; opacity: 0.4; transition: opacity 0.2s; }
    .task-guide.active { opacity: 1; transform: translateY(-50%) scale(1.05); box-shadow: 0 10px 25px rgba(0,0,0,0.1); background: white; }
    .guide-left { left: 40px; border-left: 4px solid var(--text); }
    .guide-right { right: 40px; border-right: 4px solid var(--text); }
    .key-hint { display: block; font-size: 2rem; font-weight: 700; margin-bottom: 8px; color: #cbd5e1; }
    .active .key-hint { color: #0f172a; }
    
    .rule-box { font-size: 0.9rem; margin: 4px 0; }
    .rule-title { font-weight: 700; text-transform: uppercase; font-size: 0.7rem; letter-spacing: 1px; margin-bottom: 4px; }

    /* Stimulus Card */
    .stim-card {
        width: 200px; height: 260px;
        background: white;
        border-radius: 20px;
        display: flex; flex-direction: column;
        align-items: center; justify-content: center;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        font-size: 5rem; font-weight: 800;
        transition: transform 0.1s;
        border-top: 12px solid transparent;
        position: relative;
    }
    
    /* Task Context Styles */
    .task-parity .stim-card { border-color: var(--accent-blue); }
    .task-parity .rule-parity { color: var(--accent-blue); font-weight: bold; }
    
    .task-magnitude .stim-card { border-color: var(--accent-orange); }
    .task-magnitude .rule-magnitude { color: var(--accent-orange); font-weight: bold; }

    /* Feedback Animations */
    @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }
    .feedback-error { animation: shake 0.3s ease-in-out; border: 2px solid var(--error) !important; }
    .feedback-correct { border: 2px solid var(--success) !important; }

    .overlay-msg { position: absolute; font-size: 1.5rem; color: #64748b; text-align: center; line-height: 1.5; pointer-events: none; }
  </style>
</head>
<body>

<aside class="sidebar" id="sidebar">
  <h1>Task Switching</h1>
  
  <div class="control-group">
    <label>试次数 (Trials)</label>
    <input id="nTrials" type="number" value="60" min="10">
  </div>
  <div class="control-group">
    <label>切换比例 (Switch Ratio)</label>
    <input id="switchRatio" type="number" value="0.5" step="0.1" max="1">
  </div>
  <div class="control-group">
    <label>刺激呈现时间 (ms)</label>
    <input id="stimMs" type="number" value="1000">
  </div>
  <div class="control-group">
    <label>间隔时间 (ITI ms)</label>
    <input id="itiMs" type="number" value="800">
  </div>

  <button class="btn btn-primary" id="startBtn">开始实验 (Start)</button>
  <button class="btn btn-stop" id="stopBtn" disabled>停止 (Stop)</button>

  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-val" id="accDisplay">0%</div>
      <div class="stat-label">正确率</div>
    </div>
    <div class="stat-card">
      <div class="stat-val" id="rtDisplay">-</div>
      <div class="stat-label">平均RT</div>
    </div>
    <div class="stat-card">
      <div class="stat-val" id="switchCostDisplay">-</div>
      <div class="stat-label">切换代价</div>
    </div>
  </div>
  
  <button class="btn" style="background:transparent; border:1px solid #cbd5e1; margin-top:auto;" id="exportBtn" disabled>下载数据 CSV</button>
</aside>

<main class="stage" id="stage">
  <div class="overlay-msg" id="msg">
    点击左侧“开始”<br>
    <span style="font-size:0.9rem; margin-top:10px; display:block;">按 ← 和 → 键反应</span>
  </div>

  <div class="task-guide guide-left" id="guideLeft">
    <div class="key-hint">←</div>
    <div class="rule-box rule-parity">奇数<br><span style="font-size:0.7em; color:#94a3b8;">Odd</span></div>
    <div style="height:1px; background:#e2e8f0; margin:8px 0;"></div>
    <div class="rule-box rule-magnitude">小于 5<br><span style="font-size:0.7em; color:#94a3b8;">&lt; 5</span></div>
  </div>

  <div class="stim-card" id="stimCard" style="display:none;">
    <span id="stimNum"></span>
    <div style="font-size:0.8rem; color:#94a3b8; position:absolute; bottom:20px; text-transform:uppercase; letter-spacing:2px;" id="taskLabel"></div>
  </div>

  <div class="task-guide guide-right" id="guideRight">
    <div class="key-hint">→</div>
    <div class="rule-box rule-parity">偶数<br><span style="font-size:0.7em; color:#94a3b8;">Even</span></div>
    <div style="height:1px; background:#e2e8f0; margin:8px 0;"></div>
    <div class="rule-box rule-magnitude">大于 5<br><span style="font-size:0.7em; color:#94a3b8;">&gt; 5</span></div>
  </div>
</main>

<script>
  const el = id => document.getElementById(id);
  const sleep = ms => new Promise(r => setTimeout(r, ms));
  
  // State
  let running = false;
  let abortController = null;
  let results = [];
  const numbers = [1,2,3,4,6,7,8,9]; // Exclude 5

  // UI Helpers
  const setUI = (state) => {
    el('sidebar').classList.toggle('dimmed', state === 'running');
    el('stage').classList.toggle('focus', state === 'running');
    el('startBtn').disabled = state === 'running';
    el('stopBtn').disabled = state !== 'running';
    el('nTrials').disabled = state === 'running';
  };

  const updateStats = () => {
    if(!results.length) return;
    const correct = results.filter(r => r.acc).length;
    const acc = (correct / results.length * 100).toFixed(1);
    
    const valid = results.filter(r => r.acc && r.rt);
    const avgRt = valid.length ? Math.round(valid.reduce((a,b)=>a+b.rt,0)/valid.length) : '-';
    
    // Switch Cost
    const switchTrials = valid.filter(r => r.isSwitch);
    const repeatTrials = valid.filter(r => !r.isSwitch);
    const switchRt = switchTrials.length ? switchTrials.reduce((a,b)=>a+b.rt,0)/switchTrials.length : 0;
    const repeatRt = repeatTrials.length ? repeatTrials.reduce((a,b)=>a+b.rt,0)/repeatTrials.length : 0;
    const cost = (switchRt && repeatRt) ? Math.round(switchRt - repeatRt) : '-';

    el('accDisplay').textContent = acc + '%';
    el('rtDisplay').textContent = avgRt + ' ms';
    el('switchCostDisplay').textContent = cost + ' ms';
  };

  // Logic
  async function runTask() {
    running = true;
    results = [];
    abortController = new AbortController();
    setUI('running');
    el('msg').style.display = 'none';
    el('exportBtn').disabled = true;

    const nTrials = Number(el('nTrials').value);
    const switchRatio = Number(el('switchRatio').value);
    const stimMs = Number(el('stimMs').value);
    const itiMs = Number(el('itiMs').value);

    // Build Sequence
    let curTask = Math.random() < 0.5 ? 'parity' : 'magnitude';
    const trials = [];
    for(let i=0; i<nTrials; i++) {
        const isSwitch = i > 0 && Math.random() < switchRatio;
        if(isSwitch) curTask = curTask === 'parity' ? 'magnitude' : 'parity';
        trials.push({
            id: i+1,
            task: curTask,
            num: numbers[Math.floor(Math.random() * numbers.length)],
            isSwitch: isSwitch ? 1 : 0 // Force number for CSV
        });
    }

    try {
        for (const t of trials) {
            if(abortController.signal.aborted) break;

            // 1. ITI
            el('stimCard').style.display = 'none';
            // Reset guides
            el('guideLeft').className = 'task-guide guide-left';
            el('guideRight').className = 'task-guide guide-right';
            el('stage').className = 'stage focus'; // Remove task specific classes
            
            await sleep(itiMs);
            if(abortController.signal.aborted) break;

            // 2. Stimulus
            const card = el('stimCard');
            const numEl = el('stimNum');
            const labelEl = el('taskLabel');
            
            card.className = 'stim-card'; // Reset anims
            el('stage').className = `stage focus task-${t.task}`; // Highlight rules
            el('guideLeft').classList.add('active'); // Activate guides
            el('guideRight').classList.add('active');

            numEl.textContent = t.num;
            labelEl.textContent = t.task === 'parity' ? 'Odd / Even' : '< 5 / > 5';
            
            // Set Task Color
            if(t.task === 'parity') {
                labelEl.style.color = 'var(--accent-blue)';
                card.style.borderColor = 'var(--accent-blue)';
            } else {
                labelEl.style.color = 'var(--accent-orange)';
                card.style.borderColor = 'var(--accent-orange)';
            }
            
            card.style.display = 'flex';

            // 3. Response
            const t0 = performance.now();
            const resp = await waitForResponse(stimMs, abortController.signal);
            const rt = resp ? Math.round(performance.now() - t0) : 0;
            
            // 4. Evaluate
            let correct = false;
            if(resp) {
                if(t.task === 'parity') {
                    const isOdd = t.num % 2 !== 0;
                    if(isOdd && resp === 'ArrowLeft') correct = true;
                    if(!isOdd && resp === 'ArrowRight') correct = true;
                } else {
                    const isSmall = t.num < 5;
                    if(isSmall && resp === 'ArrowLeft') correct = true;
                    if(!isSmall && resp === 'ArrowRight') correct = true;
                }
            }

            // Feedback Visual
            if(resp) {
                card.classList.add(correct ? 'feedback-correct' : 'feedback-error');
                await sleep(150); // Short freeze for feedback
            }

            results.push({ ...t, resp: resp || 'timeout', acc: correct ? 1 : 0, rt });
            updateStats();
        }
    } catch(e) {
        console.log('Aborted');
    } finally {
        running = false;
        setUI('idle');
        el('stimCard').style.display = 'none';
        el('msg').style.display = 'block';
        el('guideLeft').classList.remove('active');
        el('guideRight').classList.remove('active');
        el('stage').className = 'stage';
        el('exportBtn').disabled = false;
        el('msg').innerHTML = "任务完成<br>Task Complete";
    }
  }

  function waitForResponse(ms, signal) {
    return new Promise(resolve => {
        let timer;
        const handler = (e) => {
            if(e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                cleanup();
                resolve(e.key);
            }
            if(e.key === 'Escape') {
                cleanup();
                el('stopBtn').click();
                resolve(null);
            }
        };
        const cleanup = () => {
            clearTimeout(timer);
            window.removeEventListener('keydown', handler);
        };
        window.addEventListener('keydown', handler);
        timer = setTimeout(() => { cleanup(); resolve(null); }, ms);
        signal.addEventListener('abort', () => { cleanup(); resolve(null); });
    });
  }

  // Bindings
  el('startBtn').onclick = runTask;
  el('stopBtn').onclick = () => abortController && abortController.abort();
  
  el('exportBtn').onclick = () => {
    const csv = "Trial,Task,Num,IsSwitch,Resp,Acc,RT\n" + results.map(r => Object.values(r).join(',')).join('\n');
    const blob = new Blob([csv], {type: 'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'task_switching_data.csv';
    a.click();
  };

</script>
</body>
</html>
