<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mermaid 科学可视化编辑器 (优化版)</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #f3f4f6;
            --editor-bg: #1e1e1e;
            --editor-text: #d4d4d4;
            --panel-bg: #ffffff;
            --accent-color: #2563eb;
            --border-color: #e5e7eb;
            --error-color: #ef4444;
            --header-height: 60px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* 顶部导航栏 */
        header {
            height: var(--header-height);
            background: var(--panel-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            z-index: 10;
        }

        h1 { font-size: 18px; font-weight: 600; color: #111827; display: flex; align-items: center; gap: 8px;}
        h1 span { color: var(--accent-color); background: #eff6ff; padding: 2px 8px; border-radius: 4px; font-size: 12px; }

        .actions { display: flex; gap: 12px; }

        button {
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: white;
            color: #374151;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        button:hover { background-color: #f9fafb; border-color: #d1d5db; }
        button.primary { background: var(--accent-color); color: white; border: none; }
        button.primary:hover { background: #1d4ed8; }

        /* 主体布局 */
        main {
            display: flex;
            flex: 1;
            height: calc(100vh - var(--header-height));
        }

        /* 左侧编辑器 */
        .editor-pane {
            width: 40%;
            display: flex;
            flex-direction: column;
            background: var(--editor-bg);
            border-right: 1px solid #333;
        }

        .editor-header {
            padding: 8px 16px;
            background: #2d2d2d;
            color: #9ca3af;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        textarea {
            flex: 1;
            width: 100%;
            background: var(--editor-bg);
            color: var(--editor-text);
            border: none;
            padding: 16px;
            font-family: 'JetBrains Mono', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.5;
            resize: none;
            outline: none;
            white-space: pre;
        }

        /* 滚动条样式 */
        textarea::-webkit-scrollbar { width: 10px; }
        textarea::-webkit-scrollbar-track { background: #1e1e1e; }
        textarea::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 5px; }

        /* 右侧预览区 */
        .preview-pane {
            flex: 1;
            position: relative;
            background: var(--panel-bg);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #graph-container {
            flex: 1;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden; /* 由 svg-pan-zoom 控制 */
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* 错误提示框 */
        #error-container {
            position: absolute;
            bottom: 20px;
            right: 20px;
            left: 20px;
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #991b1b;
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            font-family: 'JetBrains Mono', monospace;
            display: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 20;
        }

        /* Mermaid 生成的 SVG 样式调整 */
        svg {
            max-width: 100%;
            height: auto;
        }
    </style>
</head>
<body>

<header>
    <h1>Mermaid Studio <span>Scientific</span></h1>
    <div class="actions">
        <button onclick="copyCode()">复制源码</button>
        <button onclick="downloadSVG()">导出 SVG</button>
        <button class="primary" onclick="downloadPNG()">导出 PNG</button>
    </div>
</header>

<main>
    <div class="editor-pane">
        <div class="editor-header">Code Input (Mermaid Syntax)</div>
        <textarea id="input" spellcheck="false" placeholder="在此粘贴 Mermaid 代码...">
%%{
  init: {
    'theme': 'neutral',
    'flowchart': { 'curve': 'monotoneX', 'padding': 15, 'nodeSpacing': 40, 'rankSpacing': 50 },
    'themeVariables': {
      'fontFamily': 'Inter, sans-serif',
      'fontSize': '14px',
      'primaryColor': '#e1f5fe',
      'primaryBorderColor': '#01579b',
      'secondaryColor': '#f3f4f6',
      'tertiaryColor': '#ffffff'
    }
  }
}%%
graph TD
    %% 定义样式类
    classDef key fill:#e3f2fd,stroke:#1565c0,stroke-width:2px,color:#0d47a1,font-weight:600
    classDef fin fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px,color:#1b5e20
    classDef gate fill:#fff3e0,stroke:#e65100,stroke-width:2px,color:#bf360c,stroke-dasharray: 5 5
    classDef ctrl fill:#fce4ec,stroke:#c2185b,stroke-width:2px,color:#880e4f
    classDef done fill:#f3f4f6,stroke:#757575,stroke-width:1px,color:#616161,stroke-dasharray: 2 2

    %% 主流程
    S0[开始] --> S1[立案阶段]:::key
    S1 --> S2[调查取证]
    S2 --> S3[审理决定]:::gate
    S3 --> S4[执行阶段]
    S4 --> S5[结案归档]:::fin

    %% 月度机制子图
    subgraph M_Cycle [月度对账与差异处理机制]
        direction TB
        M1[系统生成对账明细]:::key --> M2[主要部门对账核对]:::fin
        M2 --> M3{是否存在差异?}:::gate
        M3 -- 是 --> M4[登记原因/追溯责任/修正台账]:::ctrl
        M4 --> M1
        M3 -- 否 --> M5[对账一致/留痕归档]:::done
    end

    %% 连接主流程与子图
    S1 -.-> M_Cycle
    S2 -.-> M_Cycle
    S3 -.-> M_Cycle
    S4 -.-> M_Cycle
    S5 -.-> M_Cycle

    %% 设置连接线样式
    linkStyle 5,6,7,8,9 stroke:#90a4ae,stroke-width:1px,stroke-dasharray: 3 3
        </textarea>
    </div>

    <div class="preview-pane">
        <div id="graph-container"></div>
        <div id="error-container"></div>
    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>

<script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';

    // 初始化 Mermaid
    mermaid.initialize({ 
        startOnLoad: false,
        securityLevel: 'loose',
    });

    const input = document.getElementById('input');
    const graphDiv = document.getElementById('graph-container');
    const errorDiv = document.getElementById('error-container');
    let panZoomInstance = null;
    let cleanSvgData = null; // 用于存储未被 svg-pan-zoom 修改的原始 SVG

    // 防抖函数
    const debounce = (func, wait) => {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    };

    // 渲染函数
    const renderDiagram = async () => {
        const code = input.value;
        errorDiv.style.display = 'none';

        try {
            if (await mermaid.parse(code)) {
                // 生成 SVG
                const { svg } = await mermaid.render('mermaid-svg', code);
                cleanSvgData = svg; // 保存原始 SVG
                graphDiv.innerHTML = svg;
                
                const svgElement = graphDiv.querySelector('svg');
                svgElement.style.width = '100%';
                svgElement.style.height = '100%';

                // 启用缩放和平移
                if (panZoomInstance) { panZoomInstance.destroy(); }
                panZoomInstance = svgPanZoom(svgElement, {
                    zoomEnabled: true, controlIconsEnabled: true, fit: true, center: true, minZoom: 0.1, maxZoom: 10
                });
            }
        } catch (error) {
            console.error('Render error:', error);
            errorDiv.innerHTML = `<strong>Syntax Error:</strong><br>${error.message}`;
            errorDiv.style.display = 'block';
        }
    };

    input.addEventListener('input', debounce(renderDiagram, 500));
    renderDiagram();

    // ---------------- 工具函数 ----------------

    window.copyCode = () => {
        navigator.clipboard.writeText(input.value);
        alert('代码已复制到剪贴板');
    };

    // 修复: 导出原始、干净的 SVG
    window.downloadSVG = () => {
        if (!cleanSvgData) { alert('请先生成图表'); return; }
        const blob = new Blob([cleanSvgData], { type: 'image/svg+xml;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `flowchart-${Date.now()}.svg`;
        link.click();
        URL.revokeObjectURL(url);
    };

    // 修复: 使用更高质量和可靠性的方法导出 PNG
    window.downloadPNG = () => {
        if (!cleanSvgData) { alert('请先生成图表'); return; }

        // 1. 创建一个临时的 Image 对象来加载 SVG
        const img = new Image();
        // 将 SVG 数据转换为 base64，避免某些浏览器的跨域问题
        img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(cleanSvgData)));

        img.onload = function() {
            // 2. 创建 Canvas，设置高分辨率 (2x)
            const scale = 2;
            const canvas = document.createElement('canvas');
            // 使用 getBBox 获取的精确尺寸，或者回退到默认
            const width = img.width || 800;
            const height = img.height || 600;
            canvas.width = width * scale;
            canvas.height = height * scale;

            const ctx = canvas.getContext('2d');
            // 3. 填充白色背景
            ctx.fillStyle = "#ffffff";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            // 4. 绘制 SVG 图片
            ctx.scale(scale, scale);
            ctx.drawImage(img, 0, 0);

            // 5. 导出并下载
            const a = document.createElement('a');
            a.download = `flowchart-${Date.now()}.png`;
            a.href = canvas.toDataURL('image/png');
            document.body.appendChild(a); // Firefox 需要将元素添加到 body
            a.click();
            document.body.removeChild(a);
        };

        img.onerror = function() {
            alert('PNG 导出失败，请检查图表内容。');
        };
    };
</script>

</body>
</html>
